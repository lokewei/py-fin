# 可转债数据加载和分析工具

## 功能说明

### 核心模块

#### 1. `data_loader.py` - 数据加载和解析

**文件加载（支持变量日期）**：

支持两种方式加载数据：

```python
from data_loader import load_cb_data, merge_cb_data

# 方式1：自动加载最新数据文件
data = load_cb_data()

# 方式2：指定日期加载
data = load_cb_data(date='2026-01-09')
```

加载时会显示每个表的行数，并对格式错误的行发出警告：
```
✓ 加载 data 表: 381 行
⚠ ParserWarning: Skipping line 306: expected 15 fields, saw 16
✓ 加载 redeem 表: 387 行
```

**条款语义解析**：

自动解析强赎、下修、回售条款，提取关键信息：

- **连续天数**：如"连续30个交易日"
- **满足天数**：如"至少15个交易日"
- **触发比例**：如"130%"、"80%"、"70%"
- **比较方向**：高于/低于
- **时间限制**：如"最后两个计息年度"（仅回售）

支持中文和阿拉伯数字混合格式：
- "连续三十个交易日" → 30天
- "连续 30 个交易日" → 30天
- "至少有十五个交易日" → 15天
- "至少 15 个交易日" → 15天

**数据合并**：

将四个表（主表、强赎、下修、回售）合并为一个完整的DataFrame：

```python
df = merge_cb_data(data)
```

#### 2. `diagnose_csv.py` - CSV格式诊断工具

用于检测数据抓取脚本可能存在的bug，识别格式错误的行：

```bash
python diagnose_csv.py
```

输出示例：
```
============================================================
CSV文件格式诊断报告
============================================================

文件: data/jisilu_cb_redeem_2026-01-09.csv
表头字段数: 15
总行数: 389
⚠ 发现 1 个格式问题:
  行 306: 期望15个字段, 实际16个
    原始内容: 118024,冠宇转债,134.615,...未转股余额不足 5,000 万元时
```

**常见问题**：
- 条款文本中包含逗号（如"5,000万元"）导致字段分割错误
- 建议数据抓取脚本使用CSV库正确处理字段引号

## 使用示例

```python
from data_loader import load_cb_data, merge_cb_data

# 加载并合并数据
data = load_cb_data()
df = merge_cb_data(data)

# 查看强赎条款解析结果
for idx, row in df[df['强赎价'].notna()].head(5).iterrows():
    clause = row['强赎条款_解析']
    print(f"{row['转债名称']}: 连续{clause['连续天数']}天中至少{clause['满足天数']}天")

# 筛选特定条件的可转债
# 例如：找出强赎触发比例为130%的转债
df_130 = df[df['强赎条款_解析'].apply(
    lambda x: x.get('触发比例') == 130 if isinstance(x, dict) else False
)]
```

## 期权价值和回售收益计算

主表中已包含这两个字段，但格式可能是文字描述。可以用以下方式计算数值：

```python
# 期权价值 = 转债现价 - 纯债价值
df['期权价值_数值'] = df['现价'] - df['纯债价值']

# 简单回售收益率
df['回售收益_简单'] = (100 - df['现价']) / df['现价'] * 100

# 年化回售收益率（需要剩余年限字段）
df['回售收益_年化'] = ((100 / df['现价']) ** (1 / df['剩余年限']) - 1) * 100
```

## 注意事项

1. CSV文件编码为UTF-8 with BOM
2. 某些行可能因格式问题被跳过（使用`on_bad_lines='skip'`）
3. 条款解析基于正则表达式，可能无法覆盖所有格式变体
4. 合并后未触发强赎/下修/回售的转债，相应字段为NaN
