# 数据质量问题总结

## 发现的问题

通过诊断工具发现了2个CSV格式问题：

### 1. redeem表（强赎表）- 第306行
```
118024,冠宇转债,134.615,688772,珠海冠宇,30.890,30.889,0,22.89,120%,27.468,21.88,-,0/15 | 30,如果公司股票在连续三十个交易日中至少十五个交易日的收盘价格不低于当期转股价格的 120%（含 120%）或本次发行的可转换公司债券未转股余额不足 5,000 万元时
```

**问题**：条款中的"5,000 万元"包含逗号，导致CSV解析器将其识别为额外的字段。

### 2. put表（回售表）- 第181行
```
118049,汇成转债,287.403,688403,汇成股份,11.487,9.300,2028-08-07,7.61,70.00%,5.327,18.05,100.000,-,在本次发行的可转换公司债券最后两个计息年度，如果公司股票在任何连续三十个交易日的收盘价格低于当期转股价的70%时,一年仅可回售一次
```

**问题**：条款中的"70%时,一年仅可回售一次"包含逗号，导致字段分割错误。

## 建议修复方案

### 方案1：修改数据抓取脚本（推荐）

在保存CSV时，对包含特殊字符（逗号、引号、换行符）的字段使用引号包裹：

```python
import csv

# 正确的CSV写入方式
with open('output.csv', 'w', newline='', encoding='utf-8-sig') as f:
    writer = csv.writer(f, quoting=csv.QUOTE_MINIMAL)
    writer.writerow(['字段1', '字段2', '包含,逗号的字段'])
```

### 方案2：数据清洗（临时方案）

在数据加载时进行清洗：
- 移除数字中的千位分隔符："5,000" → "5000"
- 替换条款中的逗号为其他分隔符

## 当前处理方式

`data_loader.py` 使用 `on_bad_lines='warn'` 参数：
- 跳过格式错误的行
- 显示警告信息
- 不中断程序执行

这样可以继续分析大部分数据，同时提醒用户存在数据质量问题。

## 运行诊断

```bash
# 检查所有CSV文件的格式问题
python diagnose_csv.py

# 加载数据时会自动显示警告
python test_parser.py
```
